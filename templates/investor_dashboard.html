<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AngelFundr - Investor Dashboard</title>
    <link rel="stylesheet" href="../static/css/investor.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <header class="glass-effect">
        <div class="header-container">
            <div class="logo">
                <a href="/">AngelFundr<span class="logo-dot">.</span></a>
            </div>
            <nav>
                <ul>
                    <li class="welcome-msg">Welcome, {{ name }}</li>
                    <li><a href="/" class="nav-link">Home</a></li>
                    <li><a href="/logout" class="nav-link">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="dashboard-container">
        <!-- Investment Overview -->
        <section class="overview-section glass-effect">
            {% set total_invested = namespace(value=0) %}
            {% set active_projects = namespace(value=0) %}
            {% set total_equity = namespace(value=0) %}
            
            {% for investment in user_investments %}
                {% set total_invested.value = total_invested.value + investment.amount %}
                {% if investment.status == 'active' %}
                    {% set active_projects.value = active_projects.value + 1 %}
                {% endif %}
                {% set total_equity.value = total_equity.value + investment.equity_percentage %}
            {% endfor %}

            <div class="overview-grid">
                <div class="overview-card">
                    <i class="fas fa-chart-line"></i>
                    <h3>Total Investments</h3>
                    <p class="overview-value">${{ "%.2f"|format(total_invested.value) }}</p>
                </div>
                <div class="overview-card">
                    <i class="fas fa-project-diagram"></i>
                    <h3>Active Projects</h3>
                    <p class="overview-value">{{ active_projects.value }}</p>
                </div>
                <div class="overview-card">
                    <i class="fas fa-percentage"></i>
                    <h3>Total Equity</h3>
                    <p class="overview-value">{{ "%.2f"|format(total_equity.value) }}%</p>
                </div>
            </div>
        </section>


        <!-- Your Investments Section -->
        <section class="investments-section">
            <h2><i class="fas fa-wallet"></i> Your Investments</h2>
            <div class="investment-grid">
                {% if user_investments %}
                    {% for investment in user_investments %}
                    <div class="investment-card glass-effect">
                        <div class="card-header">
                            <h3>{{ investment.project_title }}</h3>
                            <span class="status-badge {{ investment.status }}">{{ investment.status.title() }}</span>
                        </div>
                        <div class="card-content">
                            <p class="description">{{ investment.project_description }}</p>
                            <div class="investment-details">
                                <div class="detail-item">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span>Invested: ${{ investment.amount }}</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-chart-pie"></i>
                                    <span>Equity: {{ investment.equity_percentage }}%</span>
                                </div>
                                <div class="detail-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>Deadline: {{ investment.deadline }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state glass-effect">
                        <i class="fas fa-search"></i>
                        <p>You haven't invested in any projects yet.</p>
                        <a href="#explore" class="cta-button">Explore Projects</a>
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- Explore Projects Section -->
        <section id="explore" class="explore-section">
            <h2><i class="fas fa-compass"></i> Explore Projects</h2>
            <div class="project-grid">
                {% for project in projects %}
                <div class="project-card glass-effect">
                    <div class="card-header">
                        <h3>{{ project.title }}</h3>
                        <span class="status-badge {{ project.get('status', 'active') }}">
                            {{ project.get('status', 'active').title() }}
                        </span>
                    </div>
                    <div class="card-content">
                        <p class="description">{{ project.description }}</p>
                        <div class="funding-progress">
                            <div class="progress-bar">
                                <div class="progress" style="width: {{ (project.current_funding / project.funding_goal * 100)|round(2) }}%"></div>
                            </div>
                            <div class="progress-stats">
                                <span>${{ project.current_funding|default(0) }} raised</span>
                                <span>Goal: ${{ project.funding_goal }}</span>
                            </div>
                        </div>
                        <div class="project-details">
                            <div class="detail-item">
                                <i class="fas fa-chart-pie"></i>
                                <span>Total Equity: {{ project.get('total_equity', 0) }}%</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-percentage"></i>
                                <span>Available: {{ project.get('remaining_equity', project.get('total_equity', 0)) }}%</span>
                            </div>
                            <div class="detail-item">
                                <i class="fas fa-calendar"></i>
                                <span>Deadline: {{ project.deadline }}</span>
                            </div>
                        </div>

                        {% if project.get('status', 'active') == 'active' and project.get('remaining_equity', 0) > 0 %}
                        <form class="investment-form" action="/invest/{{ project._id }}" method="POST">
                            <div class="form-group">
                                <label for="investment">Investment Amount ($)</label>
                                <input 
                                    type="number" 
                                    name="investment" 
                                    required 
                                    min="1" 
                                    placeholder="Enter amount"
                                    oninput="calculateEquity(event, {{ project.funding_goal }}, {{ project.get('total_equity', 0) }})">
                                <p class="calculated-equity"></p>
                            </div>
                            <button type="submit" class="invest-button">
                                <i class="fas fa-hand-holding-usd"></i> Invest Now
                            </button>
                        </form>
                        {% else %}
                        <div class="status-message">
                            {% if project.get('status', 'active') == 'completed' %}
                                <i class="fas fa-check-circle"></i> Funding Goal Reached
                            {% elif project.get('remaining_equity', 0) <= 0 %}
                                <i class="fas fa-info-circle"></i> No More Equity Available
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if project.get('investments', []) %}
                        <div class="investment-history">
                            <h4>Investment History</h4>
                            <ul>
                            {% for investment in project.investments %}
                                <li>
                                    <i class="fas fa-dollar-sign"></i> ${{ investment.amount }} 
                                    <i class="fas fa-chart-pie"></i> {{ investment.equity_percentage }}%
                                </li>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="empty-state glass-effect">
                    <i class="fas fa-folder-open"></i>
                    <p>No projects available at the moment.</p>
                </div>
                {% endfor %}
            </div>
        </section>
    </main>

    <script>
        function calculateEquity(event, fundingGoal, totalEquity) {
            const amount = parseFloat(event.target.value) || 0;
            const equity = ((amount / fundingGoal) * totalEquity).toFixed(2);
            const equityDisplay = event.target.closest('form').querySelector('.calculated-equity');
            equityDisplay.textContent = equity > 0 ? `Calculated Equity: ${equity}%` : '';
        }
    </script>
</body>
</html>